# Flanx Pusher Package

[![Latest Version on Packagist](https://img.shields.io/packagist/v/terciuss/flanx-pusher.svg)](https://packagist.org/packages/terciuss/flanx-pusher)
[![Total Downloads](https://img.shields.io/packagist/dt/terciuss/flanx-pusher.svg)](https://packagist.org/packages/terciuss/flanx-pusher)
[![License](https://img.shields.io/packagist/l/terciuss/flanx-pusher.svg)](https://packagist.org/packages/terciuss/flanx-pusher)
[![Tests](https://github.com/Terciuss/flanx-pusher/actions/workflows/tests.yml/badge.svg)](https://github.com/Terciuss/flanx-pusher/actions/workflows/tests.yml)

–ü–∞–∫–µ—Ç –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å WebSocket —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è–º–∏ –≤ Laravel –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è—Ö —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π Pusher-—Å–æ–≤–º–µ—Å—Ç–∏–º–æ–≥–æ –ø—Ä–æ—Ç–æ–∫–æ–ª–∞. –ü—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç –º–æ—â–Ω—É—é —Å–∏—Å—Ç–µ–º—É –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è real-time –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–æ–π —Å–æ–±—ã—Ç–∏–π –∏ –º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–æ–π.

## üöÄ –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

- ‚úÖ **WebSocket Daemon** - –ê–≤—Ç–æ–Ω–æ–º–Ω—ã–π –ø—Ä–æ—Ü–µ—Å—Å –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ WebSocket —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π
- ‚úÖ **Pusher-—Å–æ–≤–º–µ—Å—Ç–∏–º—ã–π –ø—Ä–æ—Ç–æ–∫–æ–ª** - –ü–æ–ª–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å Pusher API
- ‚úÖ **–°–∏—Å—Ç–µ–º–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ —Å–æ–æ–±—â–µ–Ω–∏–π** - –ì–∏–±–∫–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ä–∞–∑–ª–∏—á–Ω—ã—Ö —Ç–∏–ø–æ–≤ —Å–æ–±—ã—Ç–∏–π
- ‚úÖ **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ** - –£—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å –∫ —Å–±–æ—è–º —Å–µ—Ç–∏
- ‚úÖ **–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Laravel** - –ü–æ–ª–Ω–∞—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —á–µ—Ä–µ–∑ Service Provider
- ‚úÖ **–ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ** - –î–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
- ‚úÖ **–ö–æ–º–∞–Ω–¥—ã Artisan** - –£–¥–æ–±–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
- ‚úÖ **Redis –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è** - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ Redis –¥–ª—è –æ—á–µ—Ä–µ–¥–µ–π —Å–æ–±—ã—Ç–∏–π
- ‚úÖ **Event-driven –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞** - –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–±—ã—Ç–∏–π —á–µ—Ä–µ–∑ Laravel Events
- ‚úÖ **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ** - –ü–æ–ª–Ω–æ–µ –ø–æ–∫—Ä—ã—Ç–∏–µ —Ç–µ—Å—Ç–∞–º–∏

## üîó –°–≤—è–∑–∞–Ω–Ω—ã–µ –ø—Ä–æ–µ–∫—Ç—ã

- **[flanx-pusher-client](https://www.npmjs.com/package/flanx-pusher-client)** - –ö–ª–∏–µ–Ω—Ç—Å–∫–∞—è –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ –¥–ª—è JavaScript/TypeScript —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π WebSocket —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π –∏ Pusher-—Å–æ–≤–º–µ—Å—Ç–∏–º–æ–≥–æ –ø—Ä–æ—Ç–æ–∫–æ–ª–∞.

## üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞

### –ß–µ—Ä–µ–∑ Composer

```bash
composer require terciuss/flanx-pusher
```

### –ü—É–±–ª–∏–∫–∞—Ü–∏—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏

```bash
php artisan vendor:publish --tag=websocket-daemon-config
```



## üîß –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

### –ó–∞–ø—É—Å–∫ WebSocket Daemon

```bash
php artisan websocket:daemon --app-uuid=your-app-uuid --token=your-token
```

Daemon –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç WebSocket —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –∏ —Å–æ–±—ã—Ç–∏—è –∏–∑ Redis –æ—á–µ—Ä–µ–¥–∏.

### –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –∫–æ–º–∞–Ω–¥—ã

| –ü–∞—Ä–∞–º–µ—Ç—Ä | –û–ø–∏—Å–∞–Ω–∏–µ | –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–π | –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é |
|----------|----------|--------------|--------------|
| `--app-uuid` | UUID –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è | –î–∞ | - |
| `--token` | –¢–æ–∫–µ–Ω –¥–ª—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ | –î–∞ | - |
| `--host` | –•–æ—Å—Ç WebSocket —Å–µ—Ä–≤–µ—Ä–∞ | –ù–µ—Ç | localhost |
| `--port` | –ü–æ—Ä—Ç WebSocket —Å–µ—Ä–≤–µ—Ä–∞ | –ù–µ—Ç | 6001 |
| `--daemon` | –ó–∞–ø—É—Å–∫ –≤ —Ñ–æ–Ω–æ–≤–æ–º —Ä–µ–∂–∏–º–µ | –ù–µ—Ç | false |



## ‚öôÔ∏è –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–∞–∫–µ—Ç–∞ –Ω–∞—Ö–æ–¥—è—Ç—Å—è –≤ —Ñ–∞–π–ª–µ `config/websocket-daemon.php`:

```php
return [
    'defaults' => [
        'host' => env('WEBSOCKET_HOST', 'localhost'),
        'port' => env('WEBSOCKET_PORT', 6001),
        'reconnect_delay' => env('WEBSOCKET_RECONNECT_DELAY', 5),
    ],
    
    'logging' => [
        'enabled' => env('WEBSOCKET_LOGGING_ENABLED', true),
        'level' => env('WEBSOCKET_LOG_LEVEL', 'info'),
    ],
    
    'handlers' => [
        // 'message.sent' => MessageSentHandler::class,
    ],
    
    'event_handlers' => [
        '*' => \Terciuss\FlanxPusher\Handlers\DefaultEventHandler::class,
    ],
];
```

### –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è

```env
WEBSOCKET_HOST=localhost
WEBSOCKET_PORT=6001
WEBSOCKET_RECONNECT_DELAY=5
WEBSOCKET_LOGGING_ENABLED=true
WEBSOCKET_LOG_LEVEL=info
```

## üèóÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

### –û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

#### 1. WebSocketConnection
–£–ø—Ä–∞–≤–ª—è–µ—Ç WebSocket —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ–º, –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Ñ—Ä–µ–π–º—ã –∏ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç —Å—Ç–∞–±–∏–ª—å–Ω–æ–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ.

#### 2. MessageHandlerManager
–¶–µ–Ω—Ç—Ä–∞–ª—å–Ω—ã–π –º–µ–Ω–µ–¥–∂–µ—Ä –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ä–∞–∑–ª–∏—á–Ω—ã—Ö —Ç–∏–ø–æ–≤ —Å–æ–æ–±—â–µ–Ω–∏–π —á–µ—Ä–µ–∑ —Å–∏—Å—Ç–µ–º—É –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤.

#### 3. EventProcessor
–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Å–æ–±—ã—Ç–∏—è –∏–∑ Redis –∏ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—è–µ—Ç –∏—Ö –ø–æ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞–º.

#### 4. Handlers
–°–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∫–ª–∞—Å—Å—ã –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö —Ç–∏–ø–æ–≤ —Å–æ–æ–±—â–µ–Ω–∏–π.

### –°–æ–∑–¥–∞–Ω–∏–µ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞

```php
<?php

namespace App\Handlers;

use Terciuss\FlanxPusher\Handlers\AbstractHandler;
use Terciuss\FlanxPusher\Contracts\WebSocketConnectionInterface;

class CustomEventHandler extends AbstractHandler
{
    public function handle(array $data): void
    {
        // –í–∞—à–∞ –ª–æ–≥–∏–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏
        $this->connection->send([
            'type' => 'custom.event',
            'data' => $data,
            'timestamp' => now()->toISOString(),
        ]);
    }

    public function canHandle(array $data): bool
    {
        return isset($data['type']) && $data['type'] === 'custom.event';
    }
}
```

### –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞

```php
// –í –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
'handlers' => [
    'custom.event' => \App\Handlers\CustomEventHandler::class,
],

// –ò–ª–∏ –ø—Ä–æ–≥—Ä–∞–º–º–Ω–æ
$manager = app(MessageHandlerManager::class);
$manager->addHandler('custom.event', new CustomEventHandler($connection));
```

## üì° –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–±—ã—Ç–∏–π

### –ß–µ—Ä–µ–∑ EventProcessor

```php
use Terciuss\FlanxPusher\Events\EventProcessor;

EventProcessor::publishEvent([
    'type' => 'user.message',
    'data' => [
        'user_id' => 123,
        'message' => 'Hello World!',
    ],
    'channel' => 'user.123',
]);
```

### –ß–µ—Ä–µ–∑ Laravel Events

```php
<?php

namespace App\Events;

use Terciuss\FlanxPusher\Contracts\WebSocketEventInterface;

class UserMessageSent implements WebSocketEventInterface
{
    public function __construct(
        public int $userId,
        public string $message
    ) {}

    public function broadcastOn()
    {
        return ["user.{$this->userId}"];
    }

    public function broadcastWith()
    {
        return [
            'user_id' => $this->userId,
            'message' => $this->message,
            'timestamp' => now()->toISOString(),
        ];
    }

    public function broadcastAs()
    {
        return 'user.message';
    }

    public function getUserId($channel)
    {
        return $this->userId;
    }
}
```

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤

```bash
composer test
```

### –ü–æ–∫—Ä—ã—Ç–∏–µ –∫–æ–¥–∞

```bash
composer test -- --coverage-html coverage/
```

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ç–µ—Å—Ç–æ–≤

- `tests/Unit/` - –ú–æ–¥—É–ª—å–Ω—ã–µ —Ç–µ—Å—Ç—ã
- `tests/Feature/` - –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ —Ç–µ—Å—Ç—ã
- `tests/Integration/` - –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã

## üîç –û—Ç–ª–∞–¥–∫–∞

### –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

```php
// –í–∫–ª—é—á–µ–Ω–∏–µ –¥–µ—Ç–∞–ª—å–Ω–æ–≥–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
Log::channel('websocket')->info('WebSocket event processed', $data);
```

### –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

```bash
# –ü—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤
tail -f storage/logs/websocket.log

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ daemon
ps aux | grep websocket:daemon
```

## üìã –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è

- **PHP** >= 8.1
- **Laravel** >= 10.0
- **Redis** (–¥–ª—è –æ—á–µ—Ä–µ–¥–µ–π —Å–æ–±—ã—Ç–∏–π)
- **ReactPHP** (–¥–ª—è –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏)

## ü§ù –í–∫–ª–∞–¥ –≤ –ø—Ä–æ–µ–∫—Ç

1. Fork —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
2. –°–æ–∑–¥–∞–π—Ç–µ feature branch (`git checkout -b feature/amazing-feature`)
3. Commit –∏–∑–º–µ–Ω–µ–Ω–∏—è (`git commit -m 'Add amazing feature'`)
4. Push –≤ branch (`git push origin feature/amazing-feature`)
5. –û—Ç–∫—Ä–æ–π—Ç–µ Pull Request

## üìÑ –õ–∏—Ü–µ–Ω–∑–∏—è

MIT License. –°–º–æ—Ç—Ä–∏—Ç–µ —Ñ–∞–π–ª [LICENSE](LICENSE) –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏.

## üë®‚Äçüíª –ê–≤—Ç–æ—Ä

**Pavel Terciuss**

- GitHub: [@Terciuss](https://github.com/Terciuss)
- Email: mr.terks@yandex.ru